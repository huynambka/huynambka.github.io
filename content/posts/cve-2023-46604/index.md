+++
date = '2025-10-26T00:00:00+07:00'
draft = true
title = 'Phân tích CVE-2023-46604'
description = 'Phân tích CVE-2023-46604: OpenWire protocol unauth RCE'
tags = ['cve', 'java', 'deserialize', 'openwire']
+++
# CVE-2023-46604

CVE-2023-46604 là lỗ hổng RCE trong Apache ActiveMQ. Nguyên nhân xuất phát từ việc giải tuần tự (deserialization) dữ liệu không an toàn trong giao thức OpenWire – giao thức mặc định của ActiveMQ.

# ActiveMQ và OpenWire

## ActiveMQ

ActiveMQ là một message broker mã nguồn mở, viết bằng Java và là một dự án của Apache. Nó cung cấp khả năng gửi/nhận tin nhắn ứng dụng theo mô hình decoupled (queue và publish/subscribe).

ActiveMQ hỗ trợ tiêu chuẩn JMS (Java Message Service) và nhiều giao thức khác: OpenWire (mặc định), AMQP, MQTT, REST/WebSocket, ...

## OpenWire

OpenWire là giao thức nhị phân mặc định của Apache ActiveMQ để trao đổi các lệnh và tin nhắn giữa client và broker. Nó tối ưu cho hiệu năng, hỗ trợ nhiều loại message và cơ chế điều khiển (ack, transaction, flow control).

OpenWire truyền các "command" (đối tượng/dữ liệu) qua TCP/SSL theo từng frame. Mỗi frame mang một command - thực chất là một DataStructure (ví dụ ConnectionInfo, ConsumerInfo, Message, ...). Mỗi command có metadata (ví dụ size, type) và payload được marshal. 

![alt text](images/image.png)

OpenWire có nhiều phiên bản (kết nối giữa client và broker sẽ sử dụng phiên bản cao nhất mà cả 2 cùng hỗ trợ) và 2 loại encoding chính (tight/loose). 

## Example

Các bạn có thể tải mã nguồn của ActiveMQ từ [trang chủ](https://activemq.apache.org/download.html) và sử dụng file Dockerfile sau để dựng môi trường.

```Dockerfile
# Use OpenJDK 11 as base image (compatible with ActiveMQ 5.17.3)
FROM openjdk:11-jre-slim

# Set environment variables
ENV ACTIVEMQ_VERSION=5.17.3
ENV ACTIVEMQ_HOME=/opt/activemq
ENV ACTIVEMQ_CONF=/opt/activemq/conf
ENV ACTIVEMQ_DATA=/opt/activemq/data
ENV JAVA_HOME=/usr/local/openjdk-11

# Create activemq user and group
RUN groupadd -r activemq && useradd -r -g activemq activemq

# Install necessary packages
RUN apt-get update && \
    apt-get install -y \
    procps \
    net-tools \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Create directories
RUN mkdir -p ${ACTIVEMQ_HOME} ${ACTIVEMQ_DATA}

# Copy ActiveMQ installation
COPY . ${ACTIVEMQ_HOME}/

# Set permissions
RUN chown -R activemq:activemq ${ACTIVEMQ_HOME} && \
    chmod +x ${ACTIVEMQ_HOME}/bin/activemq

# Set working directory
WORKDIR ${ACTIVEMQ_HOME}

# Switch to activemq user
USER activemq

# Set Java options with debug configuration
ENV JAVA_OPTS="-Xms512M -Xmx2G \
    -Djava.util.logging.config.file=logging.properties \
    -Djava.security.auth.login.config=${ACTIVEMQ_CONF}/login.config \
    -Dcom.sun.management.jmxremote \
    -Dcom.sun.management.jmxremote.port=1099 \
    -Dcom.sun.management.jmxremote.rmi.port=1098 \
    -Dcom.sun.management.jmxremote.ssl=false \
    -Dcom.sun.management.jmxremote.authenticate=false \
    -Djava.rmi.server.hostname=0.0.0.0"

# Set ActiveMQ options with debug enabled
ENV ACTIVEMQ_OPTS="-Xdebug \
    -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=*:5005 \
    -Dactivemq.classpath=${ACTIVEMQ_HOME}/conf:${ACTIVEMQ_HOME}/lib/* \
    -Dactivemq.home=${ACTIVEMQ_HOME} \
    -Dactivemq.base=${ACTIVEMQ_HOME} \
    -Dactivemq.conf=${ACTIVEMQ_CONF} \
    -Dactivemq.data=${ACTIVEMQ_DATA}"

# Expose ports
# 61616 - OpenWire protocol
# 5672  - AMQP protocol
# 61613 - STOMP protocol
# 1883  - MQTT protocol
# 8161  - Web Console
# 1099  - JMX port
# 1098  - JMX RMI port
# 5005  - Debug port
EXPOSE 61616 5672 61613 1883 8161 1099 1098 5005

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8161/ || exit 1

# Default command - run ActiveMQ in console mode with debug options
CMD ["sh", "-c", "exec ${ACTIVEMQ_HOME}/bin/activemq console"]
```

Cùng với đoạn code sau

```java
import javax.jms.*;
import org.apache.activemq.ActiveMQConnectionFactory;
import java.io.*;

public class Main {

    public static String brokerUrl = "tcp://localhost:61616?wireFormat.cacheEnabled=false&wireFormat.tightEncodingEnabled=false";

    public static void sendTextMsg(String queueName, String text) {
        try {
            ActiveMQConnectionFactory cf = new ActiveMQConnectionFactory(brokerUrl);
            cf.setOptimizedMessageDispatch(false);
            cf.setUseCompression(false);
            Connection connection = cf.createConnection();
            connection.start();
            Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);
            Queue queue = session.createQueue(queueName);

            // Producer
            MessageProducer producer = session.createProducer(queue);
            TextMessage msg = session.createTextMessage(text);
            msg.setStringProperty("region", "apac");
            producer.send(msg);

            session.close();
            connection.close();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public static String receiveTextMsg(String queueName) {
        try {
            ActiveMQConnectionFactory cf = new ActiveMQConnectionFactory(brokerUrl);
            cf.setOptimizedMessageDispatch(false);
            cf.setUseCompression(false);
            Connection connection = cf.createConnection();
            connection.start();
            Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);
            Queue queue = session.createQueue(queueName);

            MessageConsumer consumer = session.createConsumer(queue, "region = 'apac'");
            Message m = consumer.receive(2000);
            String textMsg = null;
            if (m instanceof TextMessage) {
                textMsg = ((TextMessage) m).getText();
            }
            session.close();
            connection.close();
            return textMsg;
        } catch (Exception e) {
            e.printStackTrace();
            return null;
        }
    }

    public static void main(String[] args) throws Exception {
        sendTextMsg("test", "test");
        String msg = receiveTextMsg("test");
        System.out.println(msg);
    }
}
```

Đoạn code trên sẽ thiết lập kết nối đến broker đang lắng nghe tại `localhost:61616`, tạo ra một Producer, đăng ký một queue trên broker và gửi text message lên queue đó. Sau đó tạo tiếp một Consumer, consumer sẽ đăng ký lắng nghe queue có cùng tên với queue mà Producer gửi lên, khi có message gửi lên, broker sẽ gửi message đó đến cho consumer.

Cùng nhau phân tích cách broker/client 

Quan sát các gói tin bắt được bằng WireShark ta thấy ngoài những gói tin để trao đổi thông tin kết nối như `ConnectionInfo`, `BrokerInfo`, `ConsumerInfo`,... còn có các gói tin Response. Các gói tin này có nhiệm vụ thông báo đến bên vừa gửi message rằng message đó đã được nhận thành công và công việc có thể thực thi tiếp. Và `ExceptionResponse`, gói tin thông báo rằng đã có lỗi xảy ra sẽ là một phần rất quan trọng trong việc khai thác lỗ hổng CVE-2023-46604.

# ExeptionResponse

ExceptionResponse trong OpenWire là bản tin phản hồi lỗi mà broker gửi về khi xử lý một Command thất bại. Gói tin này được gửi khi client gửi Command có yêu cầu phản hồi (responseRequired = true) và broker throw exception trong quá trình xử lý (ví dụ sai cú pháp, quyền, đích không tồn tại, lỗi nội bộ). 

Một ExceptionResponse có cấu trúc như sau

![alt text](images/image1.png)

Các exception được truyền qua OpenWire phải kế thừa lớp Throwable, lỗi được "marshal" thành cấu trúc lỗi (bao gồm loại exception, message và stack trace) để client có thể unmarshal và hiển thị/ghi log.